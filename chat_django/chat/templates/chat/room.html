{% extends 'base_template.html' %} {% block 'body' %}{% load static %}

<div id="frame">
    <div id="sidepanel">
        <div id="profile">
            <div class="wrap-room-icon">
                <img id="profile-img" src="{% static 'images/chat-bubble.png' %}" class="online" alt="" />

                <p>{{room.room_name}}</p>
            </div>
        </div>
        <div id="search">
            <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>
            <input type="text" placeholder="Search contacts..." />
        </div>
        <div id="contacts">
            <ul>
                {% for user in room_users %}
                <li class="contact">
                    <div class="wrap">
                        <span class="contact-status online"></span>
                        <img src="{% static 'images/user-icon.svg' %}" alt="" />
                        <div class="meta">
                            <p class="name">{{user.username}}</p>
                        </div>
                    </div>
                </li>
                {% endfor %} {% for user in not_invited_users %}
                <li class="contact">
                    <div class="wrap">
                        <i class="fa fa-plus fa-lg" onclick="addUser({{user.id}})"></i>
                        <div class="meta">
                            <p class="name">{{user.username}}</p>
                        </div>
                    </div>
                </li>
                {% endfor %} {% comment %}
                <form method="POST" action="{% url 'invite_user_endpoint' room.id %}">
                    {% csrf_token %}{% load static %}
                    <select id="users" name="invited_user_id">
                        {% for user in not_invited_users %}
                        <option value="{{user.id}}">{{user.username}}</option>
                        {% endfor %}</select
                    ><br />
                    <input id="room-name-submit" type="submit" />
                </form>
                <li class="contact active">
                    <div class="wrap">
                        <span class="contact-status busy"></span>
                        <img src="http://emilcarlsson.se/assets/harveyspecter.png" alt="" />
                        <div class="meta">
                            <p class="name">Harvey Specter</p>
                            <p class="preview">
                                Wrong. You take the gun, or you pull out a bigger one. Or, you call their bluff. Or, you
                                do any one of a hundred and forty six other things.
                            </p>
                        </div>
                    </div>
                </li>
                {% endcomment %}
            </ul>
            <form method="POST" action="{% url 'invite_user_endpoint' room.id %}" id="user_invite_form">
                {% csrf_token %}
                <input type="hidden" id="invited_user_id" name="invited_user_id" value="" />
            </form>
        </div>
        <div id="bottom-bar">
            <button id="addcontact">
                <i class="fa fa-user-plus fa-fw" aria-hidden="true"></i> <span>Add contact</span>
            </button>
            <button id="settings"><i class="fa fa-cog fa-fw" aria-hidden="true"></i> <span>Settings</span></button>
        </div>
    </div>
    <div class="content">
        <div class="contact-profile">
            <img src="{% static 'images/user-icon.svg' %}" alt="" />
            <p>{{user.username}}</p>
        </div>
        <div class="messages">
            <ul id="for-inserting-message"></ul>
        </div>
        <div class="message-input">
            <div class="wrap">
                <input type="text" id="chat-message-input" placeholder="Write your message..." />
                <button id="chat-message-submit" class="submit">
                    <i class="fa fa-paper-plane" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const roomName = "{{ room.id }}";
    const curentUserName = "{{user.username}}";

    const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomName + "/");

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        document.getElementById("for-inserting-message").innerHTML += createUserMessageHtml(data);
    };

    chatSocket.onclose = function (e) {
        windows.location.host = "/chat";
        console.error("Chat socket closed unexpectedly");
    };

    document.querySelector("#chat-message-input").focus();
    document.querySelector("#chat-message-input").onkeyup = function (e) {
        if (e.keyCode === 13) {
            document.querySelector("#chat-message-submit").click();
        }
    };

    document.querySelector("#chat-message-submit").onclick = function (e) {
        const messageInputDom = document.querySelector("#chat-message-input");
        const message = messageInputDom.value;
        chatSocket.send(
            JSON.stringify({
                message: message,
            })
        );
        messageInputDom.value = "";
    };
    function makeIconCode(color) {
        let code_begin = '<svg xmlns="http://www.w3.org/2000/svg" style=fill:';
        let code_end =
            ' width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm7.753 18.305c-.261-.586-.789-.991-1.871-1.241-2.293-.529-4.428-.993-3.393-2.945 3.145-5.942.833-9.119-2.489-9.119-3.388 0-5.644 3.299-2.489 9.119 1.066 1.964-1.148 2.427-3.393 2.945-1.084.25-1.608.658-1.867 1.246-1.405-1.723-2.251-3.919-2.251-6.31 0-5.514 4.486-10 10-10s10 4.486 10 10c0 2.389-.845 4.583-2.247 6.305z"/></svg>';
        return code_begin + color + code_end;
    }
    function createUserMessageHtml({ message, color, user }) {
        return `<li class="${user == curentUserName ? "replies" : "sent"}">
            ${makeIconCode(color)}
            <p>${message}</p>
        </li>`;
    }
    function addUser(userId) {
        document.getElementById("invited_user_id").value = userId;
        document.getElementById("user_invite_form").submit();
    }
</script>
{% endblock %}
