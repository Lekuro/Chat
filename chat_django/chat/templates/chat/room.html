<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Chat Room</title>
    </head>
    <body>
        <p><a href="{% url 'logout' %}">Logout</a></p>
        <h3>{{room.room_name}}</h3>
        <textarea id="chat-log" cols="100" rows="20"></textarea><br />
        <p>user: {{user.username}}</p>
        <input id="chat-message-input" type="text" size="100" /><br />
        <input id="chat-message-submit" type="button" value="Send" />
        {{ room.id|json_script:"room-name" }} <br />
        Invite user?<br />
        <form method="POST" action="{% url 'invite_user_endpoint' room.id %}">
            {% csrf_token %}
            <select id="users" name="invited_user_id">
                {% for user in not_invited_users %}
                <option value="{{user.id}}">{{user.username}}</option>
                {% endfor %}</select
            ><br />
            <input id="room-name-submit" type="submit" />
        </form>
        <script>
            const roomName = JSON.parse(document.getElementById("room-name").textContent);

            const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomName + "/");

            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                console.log(e);
                document.querySelector("#chat-log").value += data.user + ": " + data.message + "\n";
            };

            chatSocket.onclose = function (e) {
                console.error("Chat socket closed unexpectedly");
            };

            document.querySelector("#chat-message-input").focus();
            document.querySelector("#chat-message-input").onkeyup = function (e) {
                if (e.keyCode === 13) {
                    // enter, return
                    document.querySelector("#chat-message-submit").click();
                }
            };

            document.querySelector("#chat-message-submit").onclick = function (e) {
                const messageInputDom = document.querySelector("#chat-message-input");
                const message = messageInputDom.value;
                chatSocket.send(
                    JSON.stringify({
                        message: message,
                    })
                );
                messageInputDom.value = "";
            };
        </script>
    </body>
</html>
